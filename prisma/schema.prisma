// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String? // For credentials provider
  role          UserRole  @default(BUSINESS_OWNER)
  businessId    String?
  business      Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)

  accounts Account[]
  sessions Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([email])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Business {
  id       String  @id @default(cuid())
  name     String
  email    String
  phone    String?
  address  String?
  timezone String  @default("UTC")

  // Branding (Phase 1 - Basic)
  logoUrl      String?
  primaryColor String  @default("#3b82f6") // Default blue
  businessName String // Display name for branding

  // Enhanced Branding (Phase 2)
  secondaryColor  String? // Secondary brand color
  accentColor     String? // Accent color
  backgroundColor String? // Custom background color
  textColor       String? // Custom text color
  fontFamily      String? // Custom font from Google Fonts
  faviconUrl      String? // Favicon URL

  // Domain (Phase 2)
  subdomain String? @unique

  // Booking Rules (Phase 2)
  minimumAdvanceBookingHours Int @default(2) // Minimum hours in advance for booking
  cancellationPolicyHours    Int @default(24) // Hours before booking that cancellation is allowed
  bookingBufferMinutes       Int @default(15) // Buffer time between bookings in minutes

  // Settings
  settings Json? // Store flexible settings as JSON

  // Relations
  users        User[]
  services     Service[]
  bookings     Booking[]
  customers    Customer[]
  locations    Location[]
  availability Availability?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subdomain])
}

model Location {
  id          String  @id @default(cuid())
  businessId  String
  name        String
  address     String?
  phone       String?
  email       String?
  timezone    String? // Override business timezone if needed
  isActive    Boolean @default(true)

  business Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  services Service[]
  bookings Booking[]
  availability AvailabilityLocation?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([isActive])
}

model Service {
  id          String  @id @default(cuid())
  businessId  String
  locationId  String? // Phase 2: Optional location (null = available at all locations)
  name        String
  description String?
  duration    Int // Duration in minutes
  price       Decimal @db.Decimal(10, 2)
  isActive    Boolean @default(true)

  // Additional fields
  bufferTimeBefore        Int?    @default(0) // Minutes needed before service (setup time)
  bufferTimeAfter         Int?    @default(0) // Minutes needed after service (cleanup time)
  imageUrl                String? // Service image URL
  category                String? // Service category (e.g., "Hair Services", "Massage", "Consultation")
  maxCapacity             Int?    @default(1) // Maximum number of people for group services
  cancellationPolicyHours Int? // Hours before booking that cancellation is allowed (null = no cancellation)

  business Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  location Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([locationId])
  @@index([category])
}

model Customer {
  id            String   @id @default(cuid())
  businessId    String
  email         String
  name          String
  phone         String?
  notes         String?  @db.Text // Internal notes about the customer
  
  // Relations
  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([businessId, email]) // Unique email per business
  @@index([businessId])
  @@index([email])
}

model Booking {
  id            String  @id @default(cuid())
  businessId    String
  locationId    String? // Phase 2: Optional location
  serviceId     String
  customerId    String? // Phase 2: Link to Customer model
  customerName  String  // Keep for backward compatibility
  customerEmail String
  customerPhone String?

  startTime DateTime
  endTime   DateTime
  status    BookingStatus @default(PENDING)
  notes     String?

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  location Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)
  service  Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([businessId])
  @@index([locationId])
  @@index([serviceId])
  @@index([startTime])
  @@index([customerEmail])
  @@index([customerId])
}

model Availability {
  id         String @id @default(cuid())
  businessId String @unique
  monday     Json? // Store hours as JSON: { open: "09:00", close: "17:00", isOpen: true }
  tuesday    Json?
  wednesday  Json?
  thursday   Json?
  friday     Json?
  saturday   Json?
  sunday     Json?

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AvailabilityLocation {
  id         String @id @default(cuid())
  locationId String @unique
  monday     Json? // Store hours as JSON: { open: "09:00", close: "17:00", isOpen: true }
  tuesday    Json?
  wednesday  Json?
  thursday   Json?
  friday     Json?
  saturday   Json?
  sunday     Json?

  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum UserRole {
  BUSINESS_OWNER
  STAFF
  CUSTOMER
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}
